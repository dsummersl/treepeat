# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**treepeat** is a code similarity detection tool that identifies structurally similar code blocks across and within programming languages. Unlike traditional duplicate detection tools that only find textual matches, treepeat uses Tree-sitter ASTs to detect semantic and structural similarities even when identifiers, literals, or function names differ.

### Architecture

The tool implements a multi-stage pipeline for efficient similarity detection:

```
Parse → Normalize → Shingles → MinHash → LSH Bucketing
                                             ↓
                                       Candidate pairs
                                             ↓
                                       PQ-Gram (fast filter)
                                             ↓
                                       TED (exact verification)
                                             ↓
                                       SARIF formatted results
```

Key architectural decisions (see `docs/adr/`):
- **Tree-sitter** for language-agnostic AST parsing
- **MinHash + LSH** (using datasketch library) for efficient similarity detection
- **Language-specific normalization** to strip identifiers, literals, and non-structural elements
- **SARIF output format** for integration with existing tooling

## Development Commands

**IMPORTANT**: Always use the Makefile commands for development tasks.

### Setup
```bash
make setup  # Set up venv and sync dependencies with uv
```

### Testing
```bash
make test                                    # Run all tests with pytest and coverage
uv run pytest tests/test_foo.py             # Run specific test file
uv run pytest tests/test_foo.py::test_name  # Run specific test
uv run pytest -v                             # Verbose output
```

### Code Quality
```bash
make lint   # Check code with ruff
make fix    # Auto-fix ruff issues
make type   # Type check with mypy (strict mode)
make radon  # Check cyclomatic complexity and maintainability
make ci     # Run all CI checks (lint + type + test + radon)
```

**Before completing any feature**, run `make ci` to ensure all checks pass.

## Code Quality Requirements

- **Python version**: >= 3.11
- **Type checking**: mypy in strict mode
- **Linting**: ruff with 100 character line length
- **Complexity**: Cyclomatic complexity grade A or better (radon)
- **Maintainability**: Maintainability Index grade A or better (radon)
- **Function length**: Functions must not exceed 80 lines
- **Test coverage**: pytest with coverage reporting (configured in pyproject.toml)

Writing guidance:

- Only include a brief description of the thing in docstrings (no arguments or return types)

## Project Structure

```
treepeat/       # Main package source code
tests/          # Test files (mirror treepeat/ structure)
docs/adr/       # Architecture Decision Records
```

## Tooling

- **Package manager**: uv (not pip)
- **Test framework**: pytest with pytest-cov
- **Pre-commit hooks**: ruff, ruff-format, mypy, and basic file checks
